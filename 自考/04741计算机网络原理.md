# 计算机网络原理
## 1 计算机网络概述
### 1.1 计算机网络基本概念
`计算机网络是计算机技术与通信技术相互融合的产物，计算机网络是互连的、自治的计算机的集合。`
* 自治： 互连的计算机系统彼此独立，不存在主从或者控制与被控制关系。
* 互连： 利用通信链路连接相互独立的计算机系统。通信链路可以是双绞线、光纤、微波、通信卫星等。

**协议三要素**： 语法、语义、时序
* 语法： 定义实体之间交换信息的格式与结构，或者定义实体（比如硬件设备）之间传输的电平。
* 语义： 实体间交换的信息，除了要传输的数据之外，通常还包括控制信息，针对不同的控制信息，接收端应如何响应。
* 时序： 定义实体之间交换信息的顺序以及如何匹配或适应彼此的速度。

**计算机网络的功能**：实现硬件资源共享、软件资源共享和信息资源共享。

**计算机网络的分类**：
* 按覆盖范围分类
   1. 个域网（PAN）：个人设备通过无线通信技术构成小范围网络，实现个人设备间的数据传输。范围1-10m
   2. 局域网（LAN）：通常部署在办公室、校园，采用高速有线或者无线链路连接主机，实现局部范围内高速数据传输。范围10m~1km
   3. 城域网（MAN）: 城域网是指覆盖一个城市范围的网络。范围5~50km
   4. 广域网（WAN）: 异地城域网或局域网的互连。
* 按拓扑结构分类

   `网络设备间的物理连接关系与布局`
   1. 总线型拓扑结构：采用一条广播信道作为公共传输介质，称为总线，所有结点均与总线连接，结点间的通信均通过共享的总线进行。
      * 优点：结构简单，所需电缆数量少，易于拓展。
      * 缺点：通信范围受限，故障诊断与隔离较困难，容易发生冲突。
   2. 星型拓扑结构： 采用一个中央结点与网络中的所有主机连接，主机之间的通信都通过中央结点进行，
      * 优点：易于监控管理，故障诊断与隔离容易。
      * 缺点：中央结点一旦故障，全网瘫痪，网络规模受限于中央结点的端口数量。
   3. 环形拓扑结构：利用通信链路将所有的结点连接成一个闭合的环，每个结点可以从环中接收数据，并向环中进一步转发数据。
      * 优点： 所需电缆长度短，可以使用光纤，易于避免冲突。
      * 缺点： 某结点故障容易引起全网瘫痪，新结点加入撤出麻烦，存在等待时间。
   4. 网状拓扑结构： 通过多条链路与不同结点直接连接。
      * 优点：可靠性高，一条或多条链路故障时，其他网络仍然可用。
      * 缺点：网络结构复杂，造价成本高。
   5. 树形拓扑结构： 通过级联星型拓扑网络的中央结点，构建树形网络结构。
      * 优点：易于拓展，易于故障隔离。
      * 缺点：对根节点的可靠性要求高，一旦故障，则可能导致大范围网络不可用。
   6. 混合拓扑网络：由两种以上简单拓扑网络混合连接而成的网络。
      * 优点：易于拓展，可以构建不同规模的网络。
      * 缺点：网络结构复杂，管理维护复杂。
* 按交换方式分

   `指通过彼此互连的结点间的数据转接，实现将数据从发送结点送达目的结点的过程和技术` [详见](#network-switching-technology)
* 按网络用户属性分类
   1. 公用网：由国家或企业出资建设，面向公众提供收费或免费服务的网络。
   2. 私有网：由某个组织出资建设，专门面向该组织内部业务提供网络传输服务，不向公众开放的网络。
### 1.2 计算机网络结构

网络边缘：连接到网络上的计算机、服务器、智能手机、智能家电等称为主机或端系统，这些端系统位于网络的最边缘，故称网络边缘。

接入网络：

* 电话拨号接入
* 非对称数字用户线路（ADSL）：独享，典型的下行带宽大于上行带宽。
* 混合光纤同轴电缆（HFC）接入网络：使用调制解调器连接有线电视网的入户同轴电缆，同轴电缆连接到光纤节点，在通过光纤链路连接电缆调制解调端系统，进而接入网络。

网络核心：由通信链路互连的分组交换设备构成的网络，作用是实现网络边缘主机之间，数据的中继与转发。比较典型的分组交换设备是路由器和交换机等。
### 1.3 数据交换技术

数据交换：在网络边缘的主机之间实现相互的数据传输、信息交换。

<b id="network-switching-technology">交换方式</b>：

   1. 电路交换：通过中间交换结点为两台主机之间建立一条专用的通信线路，称为电路，然后利用该电路进行通信，通信结束后再拆除电路。
      * 优点：实时性高，时延和时延抖动较小。
      * 缺点：对于突发性数据传输，信道利用率低，且传输速率单一。
   2. 报文交换：把要发送的信息附加上发送/接收主机的地址及其他控制信息，构成一个完整的报文，然后以报文为单位在交换网络的各个结点之间以**存储-转发**的方式传送，直至送达目的主机。 
      * 优点：信道利用率高。
      * 缺点：需要缓冲存储，网络的延时时间长且不固定，存在丢包现象。
   3. 分组交换：将待传输的数据分割成较小的数据块，每个数据库附加上地址、序号等控制信息构成数据分组，每个数据分组独立传输到目的地（同报文交换方式），目的地将收到的报文重新组装，还原为报文。
      * 优点：交换设备存储容量要求低，交换速度快，可靠传输效率高，更加公平。
      * 缺点：拆分组装报文造成一定的计算资源消耗，需要附加更多的控制信息，可能丢包。
### 1.4 计算机网络性能
速率：指网络单位时间内传送的数据量，有时也称为带宽。单位：Mbit/s、kbit/s、bit/s 等。

**时延**：指数据从网络中的一个结点（主机或交换设备）到达另一个结点所需要的时间。
   * 结点处理时延：每个分组到达交换结点时，验证分组报文、检索转发表以及可能修改分组的部分控制信息所消耗时间的总和。较小，一般忽略。
   * 排队时延：等待从输出链路发送到下一个交换结点（或目的主机）的等待时间，很不确定。
   * 传输时延：一个分组在输出链路发送时，从发送第一位开始，到发送最后一位为止，所用的时间。
   * 传播时延：分组中的每个比特在发送到物理介质上时，是利用物理信号的某种特征表示的。信号从发送端发送出来，经过一定距离的物理链路到达接收端所需要的时间。

时延带宽积：表示一段链路可以容纳的数据位数，也称为以位为单位的链路长度。

   `时延带宽积 = 传播时延 * 链路带宽`

吞吐量：网络实际可以达到的源主机到目的主机的数据传输速率，理想情况下约等于瓶颈链路数据。
### 1.5 计算机网络体系结构
`采用分层的方式类组织协议，每一层都有特定的功能，上一层利用下一层所提供的服务，完成本层的功能。`

**OSI参考模型**：理论体系结构，由高层到底层
* 应用层：为用户提供一个使用网络应用的接口，包括传送文件、电子邮件、P2P应用等。
* 表示层：为应用层提供一个一致的数据格式，使字符、格式等有差异的设备之间相互通信，还可以实现文本压缩/解压缩、数据加密/解密、字符编码等。
* 会话层： 逻辑上管理两台计算机建立和终止通信，核实双方身份是否有权参加会话。在建立会话以后，对进程间的对话进行控制。
* 传输层：分段/重组报文（区分发送和接收主机上的进程）、端到端（进程到进程）的可靠数据传输、流量控制和拥塞控制机制等。
* 网络层：转发与路由。
* 数据链路层：实现在相邻两结点之间的数据可靠而有效的传输。采用帧同步技术，实现有效的差错控制。
* 物理层：在传输介质上实现无结构比特流传输，规定设备之间的机械、电气、功能和规程4个特性。

**TCP/IP参考模型**：因特网体系结构，由上到下。
* 应用层：OSI参考模型的会话层和表示层的功能合并到了应用层来实现。
* 传输层：切割报文、保证端到端的可靠性，不涉及消息如何在网络中传输。传输层协议包括：
   * **TCP**：面向连接的、可靠字节流传输控制协议，需要双方经过确认，建立连接，数据分组标称链路号有序传递，对方对收到的分组予以确认陈伟可靠传送方式，不确认为不可靠传送方式，数据传送完成，拆除链路。
   * **UDP**：无连接的、不可靠数据报协议，没有建立和拆除链路的过程，要求每个分组带有全称地址，接收后需要对分组进行排序。
* 网络互连层：把数据分组发往目的网络或主机。
* 网络接口层：对应OSI参考模型中的数据链路层和物理层, 网络层IP分组在这一层被封装到底层网络的链路层数据帧中，并最终一比特流的形式在物理介质上进行传输。
### 1.6 计算机网络与因特网的发展简史

ARPAnet: 第一个分组交换计算机网络，也是当今因特网的祖先。

NCP: 网络控制协议，第一个主机到主机的协议。

## 2 网络应用
### 2.1 计算机网络应用体系结构体

客户/服务器（C/S）结构网络应用：最典型、最基本的网络应用。通信双方分为服务器应用程序和客户端程序，服务器程序需先运行， 做好接受通信的准备。客户端程序运行后，主动请求与服务器进行通信。

纯P2P结构网络应用：所有通信都是在对等的通信方之间直接进行，通信双方没有传统意义上的客户与服务器之分。任何一个对等端既可以主动发起对另一个对等端的服务请求，也可以被动地为其他对等端提供服务。

混合结构网络应用：将C/S应用与P2P应用相结合，既有中心服务器的存在，又有对等端的直接通信。
> Napster
> * 文件搜索采用C/S结构
>    * 提供者：向中央服务器登记自己的内容
>    * 利用者：向中央服务器提交查询请求
> * 文件传输使用P2P结构
>    * 文件传输在提供者和利用者间直接进行

### 2.2 网络应用通信基本原理

通信过程：运行在不同主机上的应用进程之间以C/S方式进行的通信。被动等待客户请求服务的叫服务器进程，主动发起通信请求服务的叫客户端进程。应用进程间遵循应用协议层协议交换应用层报文。

套接字（Socket）：是典型的网络应用编程的接口。应用进程之间进行通信时，真正收发报文的通道。一个应用进程可以创建多个套接字，与同一个或不同的传输层协议进行接口。对于一个传输层协议，需要为与其接口的每个套接字分配一个编号，标识该套接字，称为端口号。

进程标识符：不同主机进程间的通信，必须拥有唯一的标识。以IP地址对不同主机进行区分，以端口号对主机不同进程间进行区分。

**应用层协议**：定义了应用进程间交换的报文类型、报文构成部分具体含义以及报文交换时序等。

### 2.3 域名系统（DNS）

**域名解析**：将域名映射为IP地址的过程，称为域名解析。

**层次化域名空间**：英特网采用了层次树状结构的命名方法。域名的结构由标号序列组成，各标号之间用点隔开。如，“...三级域名.二级域名.顶级域名”
   * 国家顶级域名（nTLD）：cn表示中国，us表示美国
   * 通用顶级域名（gTLD）：最早的顶级域名com（公司或企业）、net（网络服务机构）、edu（专用的教育机构）
   * 基础结构域名：只有一个，即arpa，用于反向域名解析，因此又称为反向域名。

域名服务器：分布式层次式数据库。
   * 根域名服务器：共13台，单个字母命名，分别是a~m，每个根服务器知道所有的顶级服务器的域名和IP地址。
   * 顶级服务器：即TLD服务器，负责管理在该顶级域名服务器注册的所有二级域名。
   * 权威域名服务器：负责一个区的域名服务器，保存该区中所有主机的域名到IP地址的映射。

**解析过程**：本地域名服务器不能直接响应的解析结果，都需要从根域名服务器开始查询，然后依次是顶级域名服务器、权威域名服务器。
   * 递归查询：提供递归查询的服务器，可以替代查询主机，进行下一步的查询，并将最终解析结果发送给查询主机。如，“虽然我不知道，但我帮你问问”
   * 迭代查询：提供迭代查询的服务器，不会代替查询主机，进行下一步的查询，只是将下一步要查询的服务器告知查询主机。如，“虽然我不知道，但我推荐你找他”

### 2.4 万维网应用
`万维网（Web）的应用主要包括Web服务器、浏览器与超文本传输协议（HTTP）等。`

HTTP：Web应用的应用层协议，定义浏览器如何向服务器发送请求以及服务器如何向浏览器进行响应。

HTTP连接：HTTP基于传输层TCP传输报文。浏览器向服务器发送请求之前，首先需要建立TCP连接。HTTP在使用TCP连接策略有分非持久性连接和持久性连接。
   1. 非持久性连接：客户与服务器建立TCP连接后，通过该连接发送请求报文，接收响应报文，然后断开连接。每次获取对象，都需要建立TCP连接，每获取一个对象需要2RTT（Round Trip Time）。
   2. 持久性连接：
      * 非流水方式持久连接：也称为非管道方式持久连接，客户端在接收到前一个响应报文后，才能发出下一个对象的请求报文。与非持久性连接相比，连续请求多个对象时，只需建立一次TCP连接，每获取一个对象只需1RTT。
      * 流水方式持久连接：也称管道方式持久连接，客户端在接收到前一个响应报文之前，连续依次发送后续对象的请求报文，然后再通过该连接依次接收服务器发回的响应报文。使用流水方式持久连接是，获取一个对象的平均时间远小于1RTT，如果忽略对象传输时间，连续多个对象请求只需1RTT；

HTTP报文：
   * 组成：起始行、首部行、空白行和实体主体。其中，起始行、空白行不可缺少，首部行可以是零活多行，实体主体则根据报文类型。功能可有可无。
   * 分类：请求报文和响应报文。请求报文与响应报文区别是起始行不同。
      * 请求报文起始行：<方法>\<URL>\<协议版本>
      * 响应报文起始行：<协议版本>\<状态码>\<短语>
   * 请求方法：GET、HEAD、POST、PUT、OPTION

Cookie：指某些网站为了辨别用户身份、会话跟踪而存储在用户本地终端上的数据。

### 2.5 Internet 电子邮件
`电子邮件是最早在Internet上流行起来的网络应用之一，可实现电子化邮件的异步传输。电子邮件系统包括邮件服务器、邮件传输协议（SMTP）、邮件读取协议等。`

邮件服务器：发送和接收邮件，同时报告邮件传送情况，是电子邮件体系结构的核心。

**发送邮件**：SMTP是电子邮件中核心应用层协议。SMTP使用传输层TCP与服务器建立可靠数据传输连接，默认端口25。经历握手阶段、邮件发送阶段和关闭阶段完成邮件传送。
   * SMTP只能传送7位的ASCII码文本内容。图像、声音、视频及非英语国家文字需要转义。
   * SMTP不能包含“CRLF.CRLF”，该信息用于标识邮件内容的结束，需要转义传输。
   * SMTP是“推送”协议区别于HTTP的“拉取”协议。
   * SMTP使用TCP的连接是持久的，直到没有邮件需要发送才关闭连接。

邮件读取：邮件读取服务器的主要作用是用户身份鉴别、访问用户邮箱、根据用户请求对邮箱中的邮件进行操作等。目前，邮件读取协议包括POP3、IMAP和HTTP。其中HTTP是Web邮件系统的邮件读取协议。

### 2.6 文件传输协议 FTP
`文件传输协议（FTP）是在互联网两个主机之间实现文件互传的网络应用。`

客户与服务器建立一条TCP持久性的连接，端口号21，用于传输命令，称为控制连接。
在传输文件等数据时，客户与服务器建立一条临时TCP连接，端口号20，用于传输数据，数据传输结束便断开，称为数据连接。
FTP这种使用两条TCP连接分别传输控制命令与数据的方式，称为带外控制。另外，FTP是有状态的协议。

### 2.7 P2P应用

P2P体系结构对服务器依赖很小，甚至对于纯P2P来讲，整个应用几乎不依赖某个集中服务器，应用都是动态地在对等双方之间进行。对等方随时可能加入应用，也随时可能离开，具有很强的应用规模伸缩性。

### 2.8 Socket 编程基础

基本类型：
   * 数据报类型套接字（SOCK_DGRAM）：面向传输层UDP协议。
   * 流式套接字（SOCK_STREAM）：面向传输层TCP协议。
   * 原始套接字（SOCK_RAW）：面向网络层协议。

系统调用及其过程：
   * 基于TCP

      `服务器程序运行后，调用socket()创建主套接字ms;调用bind(ms)绑定本地端点地址;调用listen(ms)设置主套接字为监听模式;调用accept(ms)通过主套接字接收客户端连接请求，并阻塞服务器进程，直到有客户端连接请求达到，函数调用成功并返回连接套接字ss;递归调用recv(ss)通过连接套接字接收数据，直至接收完完整数据;调用send(ss)响应请求;调用close(ss)释放连接套接字;调用accept(ms)继续等待新的客户端连接请求或调用close(ms)关闭服务。`

      `客户端程序，调用socket()创建套接字cs;调用connect(cs)请求与服务器建立TCP连接;调用send(cs)与recv(cs)实现数据发送与接收;通信结束后，调用close(cs)释放套接字，从而关闭TCP连接。`
   * 基于UDP

      `服务器程序运行后，调用socket()创建套接字ums;调用bind(ums)绑定本地端点地址;调用recvfrom(ums)接收数据（单次接收完整数据报）;调用sendto(ums)发送数据;继续调用recvfrom(ums)接收数据或调用close(ums)关闭服务。`

      `客户端程序，调用socket()创建套接字ucs;调用sendto(ucs)发送数据;调用recvfrom(ums)接收数据;调用close(ucs)释放套接字。`
   
## 3 传输层
### 3.1 传输层的基本服务

核心任务：为应用进程之间提供端到端的**逻辑通信服务**。

主要功能：
   * 传输层寻址；
   * 对应用层报文进行分段和重组；
   * 对报文进行差错检测；
   * 实现进程间端到端的可靠数据传输控制；
   * 面向应用层实现复用与分解；
   * 实现端到端的流量控制；
   * 拥塞控制；

### 3.2 传输层的复用与分解

多路复用：从多个socket（进程）接收数据，为每个数据块封装**上头部标识**，生成数据报，交给网络层；

多路分用：传输层依据头部信息将收到的数据报交给正确的套接字即不同的进程。

工作流程：
   * UDP：来自不同源IP地址/端口号的IP数据报将被导向绑定在目的端口号的**同一个**socket。
   * TCP：来自不同源IP地址/端口号的IP数据报将被导向绑定在目的端口号的**不同**socket。

头部标识：
   * UPD（二元组）：目的IP地址，目的端口号
   * TCP（四元组）：目的IP地址，目的端口号，源IP地址，源端口号

### 3.3 停-等协议与滑动窗口协议

ACK(ACKnowledge Character): 接收方发应答发送方的一种传输控制字符，表示确认发来的数据已经接受无误。 

NAK(Negative Acknowledgment): 否定应答或者非应答的缩写，用于数字通信中确认数据收到但是有错误的信号或是没有收到信号。


**不可靠传输信道的不可靠性主要表现在**：
   1. 可能出现比特差错。
   2. 可能出现乱序。
   3. 可能出现数据丢失。

**实现可靠数据传输的措施**：
   1. 差错检测：利用差错码实现数据包传输过程中的比特差错检测（甚至纠正）
   2. 确认：接收方向发送方反馈接收状态。
   3. 重传：发送发重新发送接收方没有正确接收的数据。
   4. 序号：确保数据按序提交。
   5. 计时器：解决数据包丢失问题。

停-等协议工作原理：发送方发送经过差错编码和编号的报文段，等待接收方的确认；接收方如果正确接收报文段，即差错检测无误，切序号正确，则接收报文，并向发送方发送ACK，否则丢弃报文段，并向发送方发送NAK；发送方如果收到ACK，则继续发送后续报文段，否则重发刚刚发送的报文段。

滑动窗口协议工作原理：对分组连续编号，发送方按流水线方式依序发送分组；接收方接收分组，按分组序号向上有序提交，并通过向发送方报告正确接收的分组序号（也可以利用否定确认通告出现差错的分组序号）。发送方根据接收到ACK（NAK）的序号以及计时器，想接收方继续发送新的分组或者重发某些（某个）分组。

### 3.4 用户数据协议(UDP)
`用户数据报协议UDP是Internet传输层协议，提供无连接、不可靠、数据报尽力传输服务。`

**特点**：
   * 无需建立连接（减少延迟）
   * 实现简单：无需维护连接状态
   * 头部开销少
   * 没有拥塞控制：应用可以更好地控制发送时间和速率。

**数据报结构**：
> ![](./04741计算机网络原理/img/3.4数据报结构.png)

校验和（checksum）：检测UDP段在传输中是否发生错误（如位翻转）
   * 计算：将数据报内容按16位求和，进位加在和的后面，将得到的值按位取反，得到校验和。
   * 比对：接收方计算得到校验和与数据报校验和字段进行比对。
      * 不相等：检测出错误。
      * 相等：没有检测出错误，但可能有错误。

